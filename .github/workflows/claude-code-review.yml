name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # Prompt A workaround for claude code action bug of `Fork` PR
          prompt: |
              REPO: ${{ github.repository }}
              PR NUMBER: ${{ github.event.pull_request.number }}

              Please review this pull request.

              You can use multiple subagents to parallelize tasks. Each subagent should be told the PR title and description.

              Use `gh pr view <PR NUMBER> --comments` and `gh pr diff <PR NUMBER> --patch` to access the PR content.
              You are in repository without that patch applied. Do not apply it.
              Assume the patch will be build and tested by other GitHub Actions workflows.

              Focus on:
              - Code quality, style, and best practices
              - Potential bugs, issues, incorrect logic
              - Security implications
              - CLAUDE.md compliance

              For every issue, rate how significant it is. Make sure you are confident in your diagnosis.

              For every CLAUDE.md compliance violation, check if repo has other places where this issue appears.
              If it does, do not point out the violation in the place it appears.
              Instead in the final top-level comment, include a suggestion how to improve CLAUDE.md.

              Provide detailed feedback as PR comments, using inline comments for specific issues.
              Use `gh pr comment ${{ github.event.pull_request.number }} --body "..."` for top-level summary. Keep it short.
              Use `mcp__github_inline_comment__create_inline_comment` to highlight specific code issues.
              Prefix all your GitHub comments with "Claude: ".
              Use `gh pr view <PR NUMBER> --comments` output to make sure you don't comment about the same issue twice.

              When linking to code in inline comments, follow the following format precisely, otherwise the Markdown preview
              won't render correctly: https://github.com/${{ github.repository }}/blob/${{ github.event.pull_request.head.sha }}/README.md#L10-L15
          claude_args: |
              --max-turns 50
              --model claude-opus-4-6
              --allowedTools "
                Read,Write,Edit,MultiEdit,LS,Grep,Glob,
                Bash(cat:*),Bash(test:*),Bash(printf:*),Bash(jq:*),Bash(head:*),Bash(git:*),Bash(gh:*),
                mcp__github_inline_comment__create_inline_comment,
                "

          # Run even when triggered by 3rd party developer's PR
          allowed_non_write_users: "*"

          # This requires "tag mode", which is currently bugged:
          # https://github.com/anthropics/claude-code-action/issues/939
          track_progress: false

          # Enable access to other GH Actions outputs
          additional_permissions: |
              actions: read
          # plugin_marketplaces: 'https://github.com/anthropics/claude-code.git'
          # plugins: 'code-review@claude-code-plugins'
          # prompt: '/code-review:code-review ${{ github.repository }}/pull/${{ github.event.pull_request.number }}'
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options

